services:
  backend:
    build:
      context: ./www_root/waterballsa-backend
      dockerfile: ../../java/docker_file/Dockerfile
    depends_on:
      db:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/${POSTGRES_DB}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SERVER_PORT=8080
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    volumes:
      - ./www_root/waterballsa-backend/src:/app/src
      - ./www_root/waterballsa-backend/pom.xml:/app/pom.xml
      - ./www_root/waterballsa-backend/checkstyle.xml:/app/checkstyle.xml
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1"]
      interval: 15s
      timeout: 15s
      retries: 10
      start_period: 30s

  frontend:
    build:
      context: ./www_root/waterballsa-frontend
      dockerfile: ../../next/docker_file/Dockerfile
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:${BACKEND_PORT:-8080}
      - NEXT_PUBLIC_API_URL_INTERNAL=http://backend:8080
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      # Mount source code for hot reload development
      - ./www_root/waterballsa-frontend:/app
      # Anonymous volume to prevent host node_modules from overwriting container's
      # This ensures dependencies are compiled for the container's Linux environment
      # Reference: https://note.wedsatcoming.com/docs/learn-note/為什麼在Docker中使用匿名volume處理node_modules是個好方法？
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  db:
    platform: linux/amd64
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    restart: always
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    ports:
      - "${HOST_POSTGRES_PORT:-5432}:5432"
    volumes:
      - ./db/postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
