# 資料庫設計面試題 - WaterballSA 課程平台

## 說明

本面試題目基於 WaterballSA 課程平台的資料庫設計（參考 `docs/db-schema.dbml`），涵蓋權限、看課、獎勵、任務資源、購課等五大模組。

題目難度分為 Junior 和 Mid-level 兩個層級（10 題 + 20 題），著重於：

- 索引設計與效能優化
- 交易管理與資料完整性
- 正規化/反正規化權衡
- PostgreSQL 特定功能應用
- 單一資料庫架構下的實務問題

所有問題皆為開放式問答，請根據專案實際需求進行思考與回答。

---

## Junior Level (基礎題 1-10)

### 1. [Junior] Schema 基礎理解

請說明 `users` 表中為什麼要為 `username` 欄位建立 unique 索引？這個索引在註冊和登入流程中分別扮演什麼角色？

---

### 2. [Junior] 軟刪除設計

在這個專案中，所有資料表都有 `deleted_at` 欄位實作軟刪除。請解釋什麼是軟刪除？相較於直接刪除資料（硬刪除），軟刪除有哪些優缺點？

---

### 3. [Junior] Primary Key 選擇

專案中所有資料表的主鍵都使用 `bigserial` 類型。請說明為什麼選擇 `bigserial` 而不是 `serial` 或 `UUID`？在什麼情況下應該考慮使用 UUID？

---

### 4. [Junior] 外鍵關聯

`chapters` 表透過 `journey_id` 關聯到 `journeys` 表。請說明這個外鍵關聯的目的是什麼？如果刪除一個 journey（軟刪除），應該如何處理其關聯的 chapters？

---

### 5. [Junior] Enum 類型使用

`user_role` 使用 PostgreSQL 的 Enum 類型定義了三種角色：STUDENT、TEACHER、ADMIN。相較於使用 varchar 或 integer 儲存角色，使用 Enum 有什麼優勢和限制？

---

### 6. [Junior] 時間戳欄位

每個資料表都有 `created_at` 和 `updated_at` 欄位。請說明這兩個欄位的用途，以及為什麼 `updated_at` 需要在每次更新時自動更新？

---

### 7. [Junior] 唯一約束

`orders` 表中的 `order_number` 有 unique 約束。請說明為什麼訂單編號需要唯一性？如果沒有這個約束會發生什麼問題？

---

### 8. [Junior] 複合索引基礎

`chapters` 表中有一個複合唯一索引 `(journey_id, order_index)`。請說明這個索引的目的是什麼？它能防止什麼樣的資料錯誤？

---

### 9. [Junior] Decimal 精度

`journeys` 表的 `price` 欄位使用 `decimal(10,2)` 類型。請說明為什麼儲存金額要用 `decimal` 而不是 `float` 或 `double`？`(10,2)` 分別代表什麼意思？

---

### 10. [Junior] 預設值設計

`user_mission_progress` 表中 `watch_position_seconds` 預設值為 0。請說明為什麼需要設定預設值？在什麼情況下應該使用 NOT NULL + DEFAULT，而不是允許 NULL？

---

## Mid-level (進階題 11-30)

### 11. [Mid-level] 索引效能分析

`users` 表中為 `experience_points` 建立了索引 `idx_users_experience`，註解說明是「用於排行榜查詢」。請分析：

1. 這個索引對排行榜查詢（依經驗值排序）有什麼幫助？
2. 如果排行榜需要同時顯示等級和經驗值排序，是否應該改為複合索引 `(level, experience_points)`？為什麼？
3. 這個索引對使用者經驗值更新操作的效能有什麼影響？

---

### 12. [Mid-level] Token 黑名單設計

`access_tokens` 表用於實作 JWT Token 黑名單機制。請分析：

1. 為什麼需要 `expires_at` 和 `invalidated_at` 兩個時間欄位？
2. 如何設計定期清理已過期 token 的機制？
3. 在高併發場景下，這個表可能成為效能瓶頸嗎？如何優化？

---

### 13. [Mid-level] 進度追蹤併發問題

`user_mission_progress` 表記錄影片觀看進度，規格要求每 10 秒更新一次。請思考：

1. 如果使用者在多個裝置同時觀看同一影片，可能會發生什麼資料競爭問題？
2. 應該使用什麼等級的交易隔離層級（Transaction Isolation Level）來處理這種情況？
3. 如何設計更新邏輯，確保進度不會倒退？

---

### 14. [Mid-level] 複合索引順序

`orders` 表有一個複合索引 `(user_id, status)`，註解說明用於「查詢使用者的訂單狀態」。請分析：

1. 索引欄位的順序 `(user_id, status)` 是否合理？如果改成 `(status, user_id)` 會有什麼差異？
2. 這個索引能否支援「查詢特定使用者的所有訂單」？
3. 這個索引能否支援「查詢所有未付款訂單」？

---

### 15. [Mid-level] 訂單過期機制

`orders` 表中 `expired_at` 欄位用於標記訂單過期時間（建立後 3 天）。請設計：

1. 如何實作定期檢查並更新過期訂單的機制？
2. 這個定期任務應該多久執行一次？考量點是什麼？
3. 如果過期訂單數量很大，如何避免單次更新造成資料庫負擔？

---

### 16. [Mid-level] 價格快照設計

`order_items` 表中同時儲存了 `original_price`、`discount` 和 `price`。請分析：

1. 為什麼需要在訂單中「快照」課程價格，而不是關聯到 `journeys.price`？
2. 這種設計屬於正規化還是反正規化？有什麼取捨？
3. 如果未來需要支援「價格歷史查詢」功能，應該如何設計？

---

### 17. [Mid-level] 資料完整性保證

當使用者付款完成訂單時，需要同時：

1. 更新 `orders.status` 為 PAID
2. 設定 `orders.paid_at`
3. 在 `user_journeys` 中建立擁有權記錄

請說明應該使用什麼策略來確保這些操作的原子性？如果中間某個步驟失敗，應該如何處理？

---

### 18. [Mid-level] 查詢優化

請為以下查詢場景設計最佳索引策略：
「查詢使用者 A 在課程 B 中所有已完成但尚未交付的任務」

涉及的表：`user_mission_progress`, `missions`, `chapters`

請說明：

1. 需要哪些索引？
2. 索引欄位的順序應該如何安排？
3. 是否需要考慮覆蓋索引（Covering Index）？

---

### 19. [Mid-level] 軟刪除索引策略

所有資料表都有 `deleted_at` 欄位進行軟刪除。請思考：

1. 查詢時需要加上 `WHERE deleted_at IS NULL` 條件，這對索引使用有什麼影響？
2. 是否應該為 `deleted_at` 欄位建立索引？
3. 如何設計局部索引（Partial Index）來優化軟刪除場景的查詢效能？

---

### 20. [Mid-level] 任務資源多型設計

`mission_resources` 表使用 `resource_type` 區分影片、文章、表單等不同資源類型，並且 `resource_url` 和 `resource_content` 都是可選的。請評估：

1. 這種「單表多型」設計的優缺點是什麼？
2. 相較於為每種資源類型建立獨立的表（如 `video_resources`, `article_resources`），哪種設計更合適？
3. 如何確保資料的完整性約束（例如影片必須有 URL 和 duration_seconds）？

---

### 21. [Mid-level] 排行榜查詢優化

系統需要顯示經驗值排行榜（前 100 名）。當使用者數量增長到 10 萬人時，查詢開始變慢。請分析：

1. 目前的 `idx_users_experience` 索引是否足夠？查詢時應該如何撰寫 SQL？
2. 是否應該引入 Redis 等快取來儲存排行榜？更新策略為何？
3. 如果要顯示「我的排名」，應該如何設計查詢？

---

### 22. [Mid-level] 批次資料初始化

系統需要匯入 1000 門課程的初始資料，每門課程包含 10 個章節，每章節 20 個任務。請思考：

1. 如何設計高效的批次插入策略？
2. 應該使用交易嗎？如果使用，整批資料放在一個交易還是分批？
3. 如何處理部分資料匯入失敗的情況？

---

### 23. [Mid-level] 熱門課程效能問題

假設某門熱門課程有 5000 名學生同時在線上觀看影片，每 10 秒更新一次 `user_mission_progress`。請分析：

1. 這會對資料庫造成什麼樣的寫入壓力？每秒約多少次更新？
2. 可以採用什麼策略來減輕資料庫負擔？（例如：批次更新、非同步寫入）
3. 如何確保使用者關閉瀏覽器時，進度不會遺失？

---

### 24. [Mid-level] 訂單併發控制

兩個使用者可能同時對同一課程建立訂單。請思考：

1. `user_journeys` 表有 `(user_id, journey_id)` 的唯一約束，如何防止重複購買？
2. 如果使用者 A 已有未付款訂單，使用者 A 再次點擊購買，應該如何處理？
3. 應該在資料庫層級還是應用層級處理這些邏輯？各有什麼優缺點？

---

### 25. [Mid-level] 長交易問題

付款流程需要呼叫第三方支付 API（可能需要 5-10 秒），並在成功後更新訂單狀態。請分析：

1. 如果在資料庫交易中呼叫外部 API，會有什麼問題？
2. 應該如何設計交易邊界？哪些操作應該在交易內，哪些應該在交易外？
3. 如果支付成功但資料庫更新失敗，應該如何處理？

---

### 26. [Mid-level] 課程存取權限查詢

查詢「使用者是否有權限觀看某個任務」需要檢查：

1. 任務的 `access_level`（PUBLIC/AUTHENTICATED/PURCHASED）
2. 如果是 PURCHASED，需要查詢 `user_journeys` 確認使用者是否擁有該課程

請設計：

1. 這個查詢的最佳 SQL 語句
2. 需要建立哪些索引來支援這個查詢？
3. 如何避免 N+1 查詢問題（例如課程列表頁一次查詢多個課程的權限）？

---

### 27. [Mid-level] 資料一致性檢查

系統運行一段時間後，需要定期檢查資料完整性。請設計 SQL 查詢來找出以下異常：

1. 存在於 `order_items` 但對應訂單不存在或已刪除
2. 訂單狀態為 PAID，但 `paid_at` 為 NULL
3. `user_journeys` 中的使用者擁有課程，但找不到對應的已付款訂單

---

### 28. [Mid-level] 經驗值與等級同步

當使用者交付任務獲得經驗值時，需要同時更新 `users` 表的 `experience_points` 和 `level`。請思考：

1. 等級計算邏輯應該在應用層還是資料庫層（例如使用觸發器或函式）？
2. 如何確保經驗值和等級的更新是原子性的？
3. 如果有多個任務同時交付，如何避免經驗值計算錯誤？

---

### 29. [Mid-level] 反正規化權衡

為了提升查詢效能，團隊考慮在 `missions` 表中加入冗餘欄位 `journey_id`（目前需要透過 `chapters` 表才能關聯到 `journeys`）。請評估：

1. 這個反正規化設計能帶來什麼效能提升？哪些查詢會受益？
2. 會引入什麼資料一致性風險？
3. 如何維護這個冗餘欄位的正確性？應該用觸發器還是應用層邏輯？

---

### 30. [Mid-level] 資料庫連線池設計

應用使用連線池（Connection Pool）連接 PostgreSQL。請思考：

1. 連線池大小應該如何設定？設太大或太小各有什麼問題？
2. 如果發生長時間執行的查詢佔用連線，會對系統造成什麼影響？
3. 如何監控連線池的使用狀況，並設定告警閾值？

---

## 結語

以上 30 題（10 題 Junior + 20 題 Mid-level）涵蓋了資料庫設計與優化的實務議題。建議在回答時：

1. **結合實際場景**：基於 WaterballSA 專案的業務需求思考
2. **權衡取捨**：沒有完美的設計，重要的是理解每個選擇的優缺點
3. **效能量化**：盡可能用具體數據或計算說明效能影響（例如：5000 使用者 ÷ 10 秒 = 500 QPS）
4. **單一資料庫視角**：本專案使用單一 PostgreSQL 實例，不需考慮分散式系統複雜度

祝你面試順利！💪
